"use strict";const isSimple=!!document.getElementById("simpleResults"),startDisabledReasons=new Set,maxPings=11600,maxData=10485760,minimumInterval=15;let totalPings,totalData,savedSettingsHeight,updatePredictedUse;if(!isSimple){updatePredictedUse=function(){let t=parseInt(document.getElementById("durationSlider").value),e=1e3/parseInt(document.getElementById("frequencySlider").value);e>15&&(e=Math.round(e)),totalPings=Math.floor(1e3*t/e),document.getElementById("totalPings").innerHTML=totalPings;const n=document.getElementById("totalPingsPluralizer");n&&(n.style.display=totalPings>1?"inline":"none"),totalData=totalPings*parseInt(document.getElementById("sizeSlider").value)+115,document.getElementById("totalData").innerHTML=totalData<1024?`~${totalData} bytes`:totalData<1048576?(totalData/1024).toFixed(1)+" KB":(totalData/1024/1024).toFixed(2)+" MB";let s=totalPings>11600,i=totalData>maxData;if(s||totalData>maxData){let t;t="en"===document.documentElement?47:100,s?(document.getElementById("pingsThatAreTooMany").innerHTML=document.getElementById("totalPingsReason").innerText,tooManyPingsMessage.style.display="inline",t+=18):tooManyPingsMessage.style.display="none",i&&(document.getElementById("dataThatIsTooMuch").innerHTML=document.getElementById("totalData").innerText),window.innerWidth>=500?(savedSettingsHeight||(savedSettingsHeight=settings.clientHeight),settings.style.height=savedSettingsHeight+t+"px"):settings.style.height="",Array.from(document.getElementsByClassName("usageThatIsTooMuchAnd")).forEach(t=>t.style.display=s&&i?"inline":"none"),usageStopMessage.style.display="block",start.disabled=!0,startDisabledReasons.add("use")}else savedSettingsHeight&&(settings.style.height="",savedSettingsHeight=!1),usageStopMessage.style.display="none",tooManyPingsMessage.style.display="none",startDisabledReasons.delete("use"),startDisabledReasons.size||(start.disabled=!1)},updatePredictedUse();const t={7:{"ðŸ ¥":"â¬†","ðŸ §":"â¬‡"}};function presetChanged(){let t=document.getElementById("preset"),e=t.options[t.selectedIndex];["size","frequency","duration","wait"].forEach(t=>{if(t in e.dataset){let n=document.getElementById(t+"Slider");n.value=e.dataset[t],n.dispatchEvent(new Event("input"))}})}navigator.userAgent.includes("Windows NT 10")||Object.entries(t[7]).forEach(t=>document.body.innerHTML=document.body.innerHTML.replace(new RegExp(t[0],"g"),t[1])),preset.onchange=presetChanged,document.addEventListener("click",(function(t){document.querySelectorAll("nav details[open]").forEach(e=>{e.contains(t.target)||(e.open=!1)})}))}document.querySelectorAll("summary").forEach(t=>t.addEventListener("mousedown",(function(t){t.detail>1&&t.preventDefault()}),!1));let latePings,firstRun=!0;start.onclick=()=>{(totalData<3145728||isSimple||window.confirm(`This test as you've configured it will use ${(totalData/1024/1024).toFixed(2)} MB of bandwidth for both of us. Are you sure you want to run it?`))&&runTest()};const results=document.getElementById("simpleResults")||document.getElementById("results"),progress=document.getElementById("simpleProgress")||document.getElementById("progress"),workerUrl="/assets/worker.js";let worker;function runTest(){const t=isSimple?15:parseInt(document.getElementById("frequencySlider").value),e=isSimple?10:parseInt(document.getElementById("durationSlider").value),n=isSimple?105:parseInt(document.getElementById("sizeSlider").value),s=isSimple?200:parseInt(document.getElementById("waitSlider").value),i=isSimple?0:document.getElementById("delayedStart").checked?parseInt(document.getElementById("delayedStart").value):0;firstRun&&!isSimple&&(about.open=!1,settings.open=!1,firstRun=!1),start.disabled=!0,startDisabledReasons.add("running"),results.style.display="none",errorSection.style.display="none";let a,o,l=document.getElementById("server").value,r=new WebSocket(l);r.onerror=failTest,latePings=[];let c,d,h,u=[],g=0,m=0,p=!1;r.onopen=l=>{r.send("sending waiting text"),a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),r.pinger=setInterval(()=>{try{r.send("")}catch(t){}},5e3),o=0,c=[];let y=a.createDataChannel("channel",{ordered:!1,maxRetransmits:0});y.onopen=a=>{let l;progress.open=!0,progress.style.display="block";const w=1e3/t;function f(){y.send(JSON.stringify({i:o++,time:(new Date).getTime()}).padEnd(n," ")),p?isSimple||document.querySelector("sent-circle-thingy").current++:m++}function b(){if(p=!0,void 0!==l&&setTimeout(()=>{clearInterval(l)},1e3*e),!isSimple){progress.querySelectorAll("sent-circle-thingy, time-circle-thingy, received-circle-thingy").forEach(t=>{t.wait=s,"SENT-CIRCLE-THINGY"!==t.tagName&&"RECEIVED-CIRCLE-THINGY"!==t.tagName||t.start(totalPings),"TIME-CIRCLE-THINGY"===t.tagName&&t.start(e)});const t=setInterval(()=>{document.querySelector("time-circle-thingy").current++},1e3);setTimeout(()=>{clearInterval(t),document.querySelector("time-circle-thingy").current=e},1e3*e)}setTimeout(()=>{if(y.close(),r.send(JSON.stringify({type:"done"})),isSimple||document.querySelector("received-circle-thingy").finish(),results.style.display="block",results.open=!0,c.length){c.sort((t,e)=>t.i-e.i),d=c.reduce((t,e)=>({ping:t.ping+e.ping})).ping/c.length;let t=0,e=0;for(let n=0;n<c.length;n++)t+=Math.abs(c[n].ping-d),c[n].i!==n+e&&(u.push(n),g++,e++);h=t/(c.length-1),isSimple||(latency.innerHTML=d.toFixed(2),jitter.innerHTML=h.toFixed(2))}else isSimple||(latency.innerHTML="âˆž",jitter.innerHTML="âˆž");let t=c.length+g;if(t<o-m)for(g+=o-t;t<o;t++)u.push(t);if(isSimple)setSimpleResults(g,o-m);else{setResults(packetLoss,g,o-m),0===g&&(setResults(upload,g,o-m),setResults(download,g,o-m)),setResults(document.getElementById("late"),latePings.length,o-m);let t=new Array(o).fill(null);c.forEach(e=>t[e.i]=e.ping),drawChart(t,s,d,h),disableDownloads()}endStartButtonRunningDisable()},1e3*e+s+w+500)}w>15?l=setInterval(f,Math.round(w)):(worker.onmessage=t=>{!0===t.data.send&&f()},worker.postMessage({interval:w,duration:1e3*(i+e)})),i?setTimeout(b,1e3*i):b()},y.onmessage=t=>{if(p){let e=JSON.parse(t.data);if(e.i>=m){let t=(new Date).getTime()-e.time;e.i-=m;let n={i:e.i,ping:(new Date).getTime()-e.time};c.push(n),t<=s&&!isSimple?document.querySelector("received-circle-thingy").received(e.i):(latePings.push(n),isSimple||document.querySelector("received-circle-thingy").received(e.i,!0))}}},a.onconnectionstatechange=t=>a.connectionState,a.oniceconnectionstatechange=t=>a.iceConnectionState,a.onicecandidate=t=>{t.candidate&&r.send(JSON.stringify({type:"ice",ice:t.candidate}))},a.createOffer().then(t=>a.setLocalDescription(t)).then(()=>{r.send(JSON.stringify(a.localDescription))})},r.onmessage=i=>{if(!i.data)return!1;var l;try{l=JSON.parse(i.data)}catch(t){}if(l)if("answer"===l.type)a.setRemoteDescription(l);else if("results"===l.type){l.list.sort((t,e)=>t-e),l.list.splice(0,m),l.receivedCount-=m;for(let t=0;t<l.list.length;t++)l.list[t]-=m;let i=[];for(let t=0;t<l.receivedCount;t++)if(0===t&&0!==l.list[t])i.push(0);else if(l.list[t]!==l.list[t-1]+1)for(let e=l.list[t-1]+1;e<l.list[t];e++)i.push(e);isSimple||(document.querySelector("sent-circle-thingy").setResults(i),prepareDownloads(o,c,i,g,latePings.length,o-m,d,h,e,t,n+115,s),setResults(upload,i.length,o-m),setResults(download,g-i.length,l.receivedCount))}else"ice"===l.type&&a.addIceCandidate(l.ice);return!1},r.onclose=t=>{clearInterval(r.pinger),console.log("WebSocket closed")}}function failTest(){endStartButtonRunningDisable(),"block"!==errorSection.style.display&&(progress.open=!1,results.open=!1,errorContent.innerHTML="<p>Sorry, some error has stopped the test from starting. This could be my bad, or your connection could have just failed. Feel free to try again.</p>",errorSection.style.display="block")}function endStartButtonRunningDisable(){startDisabledReasons.delete("running"),startDisabledReasons.size||(start.disabled=!1)}"packetlosstest.com"===document.domain?worker=new Worker(workerUrl):fetch(workerUrl).then(t=>t.blob()).then(t=>worker=new Worker(URL.createObjectURL(t))),isSimple&&runTest();const badColor="#E53A43",goodColor="#E2690C",grayColor="#CCCCCC",lateColor="#E2980C",maybeColor="#F5A262";class ProgressCircleThingy extends HTMLElement{static defaultColor(){return"#E2690C"}get current(){return this.getAttribute("current")}set current(t){t?this.setAttribute("current",t):this.setAttribute("current","0"),this.update()}get total(){return this.getAttribute("total")}set total(t){t?this.setAttribute("total",t):this.setAttribute("total","0")}get percent(){return this.getAttribute("percent")}set percent(t){this.setAttribute("percent",t),this.percentText.innerHTML=(100*t).toFixed(0)+"%"}constructor(){super(),this.style.position="relative";let t,e,n=this.attachShadow({mode:"open"});function s(t=200){let e=document.createElement("canvas");e.style.position="absolute";let s=window.matchMedia("(min-width: 665px)");function i(t){t.matches?e.style.marginLeft="15px":e.style.marginLeft="0"}i(s),s.addListener(i),e.width=t,e.height=t,e.style.maxWidth="calc((100vw - 20px) / 3)",e.style.maxHeight="calc((100vw - 20px) / 3)",n.appendChild(e);let a=e.getContext("2d");return a.lineWidth=15,[e,a]}[t,e]=s(),e.strokeStyle="#CCCCCC",e.arc(t.width/2,t.width/2,t.width/2-15,.6*Math.PI,.4*Math.PI),e.stroke(),[t,e]=s(),e.strokeStyle="#E2690C",this.canvas=t,this.context=e;let i=document.createElement("div");this.bigText=i;let a=window.matchMedia("(min-width: 450px)");function o(t){t.matches?i.style.fontSize="42px":i.style.fontSize="9.75vw"}o(a),a.addListener(o),i.style.margin="35% auto 0",i.style.textAlign="center",i.style.width="50%",n.appendChild(i);let l=document.createElement("div");this.smallText=l,l.style.fontSize="16px",l.style.margin="5px auto",l.style.paddingLeft="50%",l.style.width="50%",n.appendChild(l);let r=document.createElement("div");this.percentText=r,r.style.fontFamily="'Squada One', sans-serif",r.style.fontSize="20px",r.style.margin="calc(10px + 8%) auto 7%",r.style.textAlign="right",r.style.width="15%",n.appendChild(r)}start(t){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle=this.constructor.defaultColor(),this.painted=0,this.total=t,this.current=0}update(){this.bigText.innerHTML=this.getAttribute("current"),this.smallText.innerHTML="/ "+this.getAttribute("total"),this.percent=this.getAttribute("current")/this.getAttribute("total")}}class SentCircleThingy extends ProgressCircleThingy{static defaultColor(){return"#F5A262"}update(){super.update(),this.context.beginPath(),this.context.arc(this.canvas.width/2,this.canvas.width/2,this.canvas.width/2-15,.6*Math.PI+1.8*Math.PI*(this.painted/this.getAttribute("total")),.4*Math.PI-1.8*Math.PI*(1-this.percent)),this.context.stroke(),this.painted=this.getAttribute("current")}setResults(t){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="#E2690C",this.context.beginPath(),this.context.arc(this.canvas.width/2,this.canvas.width/2,this.canvas.width/2-15,.6*Math.PI,.4*Math.PI-1.8*Math.PI*(1-this.percent)),this.context.stroke(),this.context.strokeStyle=badColor;let e=this.getAttribute("total");t.forEach(t=>{this.context.beginPath(),this.context.arc(this.canvas.width/2,this.canvas.width/2,this.canvas.width/2-15,.6*Math.PI+1.8*Math.PI*(t/e),.4*Math.PI-1.8*Math.PI*(1-(t+1)/e)),this.context.stroke()})}}class TimeCircleThingy extends ProgressCircleThingy{get total(){return super.name}set total(t){super.total=t,this.targetTime=(new Date).getTime()+1e3*t}start(t){super.start(t);let e=this.context,n=this.canvas;function s(){e.clearRect(0,0,n.width,n.height),e.beginPath(),this.percent=1-(this.targetTime-(new Date).getTime())/(1e3*this.getAttribute("total")),e.arc(n.width/2,n.width/2,n.width/2-15,.6*Math.PI,.4*Math.PI-1.8*Math.PI*(1-this.percent)),e.stroke(),this.targetTime>(new Date).getTime()&&window.requestAnimationFrame(()=>s.call(this))}window.requestAnimationFrame(()=>s.call(this))}format(t){return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`}update(){this.bigText.innerHTML=this.format(this.getAttribute("current")),this.smallText.innerHTML="/ "+this.format(this.getAttribute("total")),this.percent=this.getAttribute("current")/this.getAttribute("total")}}class ReceivedCircleThingy extends ProgressCircleThingy{start(t){super.start(t),this.waiting=[]}received(t,e=!1){if(e?this.context.strokeStyle="#E2980C":this.current++,t in this.waiting&&clearTimeout(this.waiting[t]),this.context.beginPath(),this.context.arc(this.canvas.width/2,this.canvas.width/2,this.canvas.width/2-15,.6*Math.PI+1.8*Math.PI*(t/this.getAttribute("total")),.4*Math.PI-1.8*Math.PI*(1-(t+1)/this.getAttribute("total"))),this.context.stroke(),e)this.context.strokeStyle="#E2690C";else if(t>this.painted){let e=latePings.map(t=>t.i);for(let n=this.painted;n<t;n++)e.includes(n)||(this.waiting[n]=setTimeout(t=>{this.context.strokeStyle=badColor,this.context.beginPath(),this.context.arc(this.canvas.width/2,this.canvas.width/2,this.canvas.width/2-15,.6*Math.PI+1.8*Math.PI*(t/this.getAttribute("total")),.4*Math.PI-1.8*Math.PI*(1-(t+1)/this.getAttribute("total"))),this.context.stroke(),this.context.strokeStyle="#E2690C"},this.wait,n))}t+1>this.painted&&(this.painted=t+1)}finish(){this.painted+1<document.querySelector("sent-circle-thingy").current&&(this.context.strokeStyle=badColor,this.context.beginPath(),this.context.arc(this.canvas.width/2,this.canvas.width/2,this.canvas.width/2-15,.6*Math.PI+1.8*Math.PI*(this.painted/this.getAttribute("total")),.4*Math.PI-1.8*Math.PI*(1-document.querySelector("sent-circle-thingy").percent)),this.context.stroke(),this.context.strokeStyle="#E2690C")}}function setResults(t,e,n){t.querySelector(".percent").innerHTML=0===n?"--":(e/n*100).toFixed(1),t.querySelector(".counts").innerHTML=`(${e} / ${n})`}function setSimpleResults(t,e){if(progress.style.display="none",Array.from(document.querySelectorAll("#simpleResults .result")).forEach(t=>t.style.display="none"),0!==e){const n=t/e;console.log(n),n<.01?document.querySelector(".result.very-good").style.display="block":n<.025?document.querySelector(".result.good").style.display="block":n<.075?document.querySelector(".result.fair").style.display="block":n<.15?document.querySelector(".result.bad").style.display="block":document.querySelector(".result.very-bad").style.display="block"}}if(isSimple||(progress.style.display="block",customElements.define("sent-circle-thingy",SentCircleThingy),customElements.define("time-circle-thingy",TimeCircleThingy),customElements.define("received-circle-thingy",ReceivedCircleThingy),progress.style.display="none"),!Chart)throw new Error("The Chart.js library failed to load.");let chart;function drawChart(t,e,n,s){let i=t.map(t=>null===t?badColor:t<e?"#E2690C":"#E2980C");chart&&chart.destroy(),chart=new Chart(document.getElementById("chart").getContext("2d"),{type:"bar",data:{datasets:[{label:document.getElementById("acceptable-delay-term").innerText,data:new Array(t.length).fill(e),type:"line",backgroundColor:"#E53A43aa",borderColor:badColor,fill:!1,pointRadius:0},{borderColor:i,backgroundColor:i.map(t=>t+"aa"),label:document.getElementById("response-time-term").innerText,data:t}],labels:[...Array(t.length)].map((t,e)=>document.getElementById("packet-term").innerText+" #"+(e+1))},options:{legend:{display:!1},maintainAspectRatio:!1,responsive:!0,scales:{xAxes:[{categoryPercentage:1,barPercentage:1,gridLines:{display:!1},ticks:{display:!1}}],yAxes:[{ticks:{beginAtZero:!0,callback:function(t,e,n){return t+document.getElementById("ms-term").innerText},max:5*Math.ceil(Math.max(Math.min(Math.max(...t),2*e),e,n+2*s)/5)}}]},tooltips:{callbacks:{label:function(t,e){let n=e.datasets[t.datasetIndex].label||"";return n&&(n+=": "),n+=t.yLabel+document.getElementById("ms-term").innerText,n}},position:"custom"}}})}function disableDownloads(){document.getElementById("download-results").classList.add("disabled")}function prepareDownloads(t,e,n,s,i,a,o,l,r,c,d,h){let u=[];e.forEach(t=>u[t.i]={id:t.i+1,status:"success",ping:t.ping});for(let e=0;e<t;e++)if(void 0===u[e]){let t;t=n.includes(e)?"failedOnUpload":"failedOnDownload",u[e]={id:e+1,status:t}}const g=(new Date).toISOString(),m="id,status,ping\n"+u.map(t=>`${t.id},${t.status},${t.ping||""}`).join("\n");document.getElementById("download-csv").href=URL.createObjectURL(new Blob([m],{type:"text/csv"})),document.getElementById("download-csv").download=`packet-loss-test-results-${g}.csv`;const p=`Total Packet Loss: ${(s/a*100).toFixed(2)}%\nUpload Packet Loss: ${(n.length/a*100).toFixed(2)}%\nDownload Packet Loss: ${((s-n.length)/a*100).toFixed(2)}%\nLate Packet Rate: ${(i/a*100).toFixed(2)}%\n\nAverage Latency: ${o.toFixed(2)}ms\nAverage Jitter: ${l.toFixed(2)}ms\n\nTest Settings:\n  Duration: ${r} seconds\n  Frequency: ${c} pings/second\n  Average Size: ${d} bytes\n  Acceptable Delay: ${h}ms\n\nDetails:\n--------------\n`;document.getElementById("download-csv-with-summary").href=URL.createObjectURL(new Blob([p+m],{type:"text/plain"})),document.getElementById("download-csv-with-summary").download=`packet-loss-test-results-${g}.txt`;const y=JSON.stringify({totalPacketLoss:Math.round(s/a*1e3)/1e3,uploadPacketLoss:Math.round(n.length/a*1e3)/1e3,downloadPacketLoss:Math.round((s-n.length)/a*1e3)/1e3,latePacketRate:Math.round(i/a*1e3)/1e3,averageLatency:Math.round(100*o)/100,averageJitter:Math.round(100*l)/100,settings:{duration:r,frequency:c,size:d,acceptableDelay:h},details:u});document.getElementById("download-json").href=URL.createObjectURL(new Blob([y],{type:"application/json"})),document.getElementById("download-json").download=`packet-loss-test-results-${g}.json`,document.getElementById("download-results").classList.remove("disabled")}Chart.defaults.global.elements.point.hitRadius=2,Chart.Tooltip.positioners.custom=(t,e)=>e;
